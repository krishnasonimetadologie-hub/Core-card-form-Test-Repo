<!-- MT-7455 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Core Card</title>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }


    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      color: #0a2a43;
      font-size: clamp(11px, 2.5vw, 13px); /* smaller on mobile */
      position: relative;
      z-index: 0;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("https://i.ibb.co/hJfMMh17/image-2.png");
      opacity: 0.25;
      background-repeat: no-repeat;
      background-position: top center;
      background-size: 100% 100%;
      z-index: -1;
    }


    .header {
      text-align: center;
      padding: 18px 12px 8px;
    }

    .header img {
      height: 52px;
      width: 160px;
      margin-bottom: 4px;
    }

    .header .tag {
      font-size: clamp(13px, 3vw, 15px);
      font-weight: 600;
    }

    .header .tag div {
      font-size: clamp(11px, 2.6vw, 12.5px);
      font-style: italic;
      font-weight: 500;
      margin-top: 3px;
    }


    .page {
      max-width: 660px;
      margin: 6px auto 20px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .title {
      margin-top: 12px;
      font-size: clamp(17px, 4vw, 22px);
      text-align: center;
      font-weight: 600;
      color: #2f5fa7;
    }

    
    .form-wrap {
      padding: 16px 22px 22px;
    }

    .row {
      display: flex;
      flex-direction: column;
      margin-bottom: 9px;
    }

    .row label {
      font-size: clamp(11px, 2.6vw, 12.5px);
      font-weight: 500;
      margin-bottom: 3px;
      color: #333;
    }

    .row input,
    .row textarea,
    .pairs-grid input {
      width: 100%;
      border: none;
      background: #f0f4f9;
      border-radius: 4px;
      padding: 8px 9px;
      font-size: clamp(11.5px, 2.7vw, 13px);
      outline: none;
    }

    .row textarea {
      min-height: 60px;
      resize: vertical;
    }

    .pairs-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .pairs-grid .field {
      display: flex;
      flex-direction: column;
    }

    .pairs-grid label {
      font-size: clamp(11px, 2.6vw, 12.5px);
      font-weight: 500;
      margin-bottom: 3px;
      color: #333;
    }

    
    .terms {
      font-size: clamp(10.5px, 2.5vw, 12px);
      color: #333;
      line-height: 1.4;
      margin-top: 8px;
    }

    .terms a {
      color: #0a2a43;
      font-weight: 600;
      text-decoration: underline;
    }


    .submit-wrap {
      text-align: center;
      margin-top: 14px;
    }

    .submit-btn {
      background: #2f5fa7;
      color: #ffffff;
      padding: 7px 26px;
      border-radius: 4px;
      border: none;
      font-size: clamp(12px, 3vw, 14px);
      font-weight: 600;
      cursor: pointer;
    }

    @media (max-width: 375px) {
      body {
        font-size: 11px;
      }

      .title {
        font-size: 16px;
      }

      .submit-btn {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="header">
    <img src="https://i.ibb.co/ZpQnHQLd/image.png" alt="CRS Jet Spares" />
    <div class="tag">
      Parts. Problems. Solved
      <div>We offer More than just Parts. We offer Solutions.</div>
    </div>
  </div>

  <!-- CARD -->
  <div class="page">
    <div class="title">Core Card</div>

    <!-- FORM WRAPPER -->
    <div class="form-wrap">
      <form
        action="https://prod-avs-crsjetspares--crsdev25.sandbox.my.salesforce.com/servlet/servlet.WebToCase?encoding=UTF-8&orgId=00DVA000007Hanq"
        method="POST"
        novalidate
      >


        <input type="hidden" name="orgid" value="00DVA000007Hanq" /> <!-- Org ID -->
        <input type="hidden" name="retURL" value="https://crsjetspares.com" /> <!-- Redirect URL -->
        <input type="hidden" name="recordType" value="Sales" /> <!-- RecordType -->
        <input type="hidden" name="type" value="Sales" /> <!-- Type -->
        <input type="hidden" name="00NVA0000095wfh" value="Information" /> <!-- Sub_Type__c -->
        <input type="hidden" name="00NVA0000095x8j" value="Core Card Form" /> <!-- Category__c -->

        <!-- SUBJECT -->
        <div class="row">
          <label>Sales Order Number <span style="color:red">*</span></label>
          <input id="subject" name="subject" type="text" /> <!-- Case.Subject -->
        </div>

        <!-- CUSTOMER NAME -->
        <div class="row">
          <label>Customer Name <span style="color:red">*</span></label>
          <input name="00NVA00000AeR8b" type="text" /> <!-- Customer_Name__c -->
        </div>

        <!-- COMPANY -->
        <div class="row">
          <label>Company Name <span style="color:red">*</span></label>
          <input name="company" type="text" /> <!-- Company -->
        </div>

        <!-- PART NUMBER -->
        <div class="row">
          <label>Part Number <span style="color:red">*</span></label>
          <input name="00NVA0000095LtD" type="text" /> <!-- Part_Number__c -->
        </div>

        <!-- SERIAL NUMBER -->
        <div class="row">
          <label>Serial Number <span style="color:red">*</span></label>
          <input name="00NVA0000095LtI" type="text" /> <!-- Serial_Number__c -->
        </div>

        <!-- TSN / TSO / CSN / CSO -->
        <div class="pairs-grid">
          <div class="field">
            <label>TSN *</label>
            <input name="00NVA0000095LtK" type="text" /> <!-- TSN__c -->
          </div>
          <div class="field">
            <label>TSO *</label>
            <input name="00NVA0000095LtL" type="text" /> <!-- TSO__c -->
          </div>
          <div class="field">
            <label>CSN *</label>
            <input name="00NVA0000095Lt8" type="text" /> <!-- CSN__c -->
          </div>
          <div class="field">
            <label>CSO *</label>
            <input name="00NVA0000095Lt9" type="text" /> <!-- CSO__c -->
          </div>
        </div>

        <!-- AIRCRAFT DETAILS -->
        <div class="row">
          <label>Aircraft Type *</label>
          <input name="00NVA0000095Lt7" type="text" /> <!-- Aircraft_Type__c -->
        </div>

        <div class="row">
          <label>Aircraft Serial Number *</label>
          <input name="00NVA0000095Lt5" type="text" /> <!-- Aircraft_Serial__c -->
        </div>

        <div class="row">
          <label>Aircraft Tail Number *</label>
          <input name="00NVA0000095Lt6" type="text" /> <!-- Aircraft_Tail__c -->
        </div>

        <!-- REASON FOR REMOVAL -->
        <div class="row">
          <label>Reason For Removal *</label>
          <textarea name="00NVA0000095LtG"></textarea> <!-- Reason_For_Removal__c -->
        </div>

        <!-- TERMS -->
        <div class="terms">
          I hereby state this part was removed from the aircraft identified above and has not been subjected to any major engine failure, accident, or fire.
          By submitting the digital core card form, you agree to the
          <a href="https://crsjetspares.com/general-terms-and-conditions-for-sale-and-exchange-of-goods/" target="_blank">
            Terms and Conditions
          </a>.
        </div>

        <!-- SUBMIT -->
        <div class="submit-wrap">
          <button class="submit-btn" type="submit">Submit</button>
        </div>

      </form>
    </div>
  </div>

  <script>
    const CLIENT_ID = '3MVG9O_Hkc8TP1aFEeEWU9ZyX2f05bkHPl2XawuPFSJwal8ZF1mDPue9o0kPDBVcOU64PRCCEZnQq2aIJmKv5';
    const CLIENT_SECRET = '4DA156C1380C7AA53FCE2C408620F764D3D46C7C4453D58077B173206EA351C5';
    const SF_INSTANCE = 'https://prod-avs-crsjetspares--crsdev25.sandbox.my.salesforce.com';
    const OAUTH_URL = SF_INSTANCE + '/services/oauth2/token';
    const API_ENDPOINT = SF_INSTANCE + '/services/apexrest/caseManagement/';

    async function getAccessToken() {
      const params = new URLSearchParams();
      params.append('grant_type', 'client_credentials');
      params.append('client_id', CLIENT_ID);
      params.append('client_secret', CLIENT_SECRET);

      const response = await fetch(OAUTH_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params
      });

      if (!response.ok) {
        throw new Error('Failed to authenticate');
      }

      const data = await response.json();
      return data.access_token;
    }

    async function verifySalesOrder(salesOrderNumber, accessToken) {
      const url = API_ENDPOINT + '?salesOrderNumber=' + encodeURIComponent(salesOrderNumber);

      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error('Failed to verify sales order');
      }

      return await response.json();
    }

    function extractSalesOrderNumber(subject) {
      const match = subject.match(/SO-\d+/i);
      return match ? match[0].toUpperCase() : null;
    }

    document.querySelector("form").addEventListener("submit", async function (e) {
      e.preventDefault(); 

      const subject = document.getElementById("subject");
      const submitBtn = document.querySelector(".submit-btn");

      if (!subject.value.trim()) {
        alert("Please enter the Sales Order Number.");
        return;
      }

      const salesOrderNumber = extractSalesOrderNumber(subject.value);
      if (!salesOrderNumber) {
        alert("Please enter a valid Sales Order Number in the format SO-XXXXX");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying...';

      try {
        const accessToken = await getAccessToken();

        const verificationResult = await verifySalesOrder(salesOrderNumber, accessToken);

        if (verificationResult.salesOrderExists) {
          
          if (!subject.value.startsWith("Support related to ")) {
            subject.value = "Support related to " + subject.value;
          }

          alert("Thank You - your form has been submitted");
          e.target.submit();
        } else {
          alert("Mentioned Sales Order number does not exist with Us");
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
        }
      } catch (error) {
        console.error('Verification error:', error);
        alert("An error occurred while verifying the sales order. Please try again.");
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
      }
    });
  </script>

</body>
</html>
