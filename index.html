
<!-- MT-7455 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Core Card</title>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }


    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      color: #0a2a43;
      font-size: clamp(11px, 2.5vw, 13px); /* smaller on mobile */
      position: relative;
      z-index: 0;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("https://i.ibb.co/hJfMMh17/image-2.png");
      opacity: 0.25;
      background-repeat: no-repeat;
      background-position: top center;
      background-size: 100% 100%;
      z-index: -1;
    }


    .header {
      text-align: center;
      padding: 18px 12px 8px;
    }

    .header img {
      height: 52px;
      width: 160px;
      margin-bottom: 4px;
    }

    .header .tag {
      font-size: clamp(13px, 3vw, 15px);
      font-weight: 600;
    }

    .header .tag div {
      font-size: clamp(11px, 2.6vw, 12.5px);
      font-style: italic;
      font-weight: 500;
      margin-top: 3px;
    }


    .page {
      max-width: 660px;
      margin: 6px auto 20px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .title {
      margin-top: 12px;
      font-size: clamp(17px, 4vw, 22px);
      text-align: center;
      font-weight: 600;
      color: #2f5fa7;
    }

    
    .form-wrap {
      padding: 16px 22px 22px;
    }

    .row {
      display: flex;
      flex-direction: column;
      margin-bottom: 9px;
    }

    .row label {
      font-size: clamp(11px, 2.6vw, 12.5px);
      font-weight: 500;
      margin-bottom: 3px;
      color: #333;
    }

    .row input,
    .row textarea,
    .pairs-grid input {
      width: 100%;
      border: none;
      background: #f0f4f9;
      border-radius: 4px;
      padding: 8px 9px;
      font-size: clamp(11.5px, 2.7vw, 13px);
      outline: none;
    }

    .row textarea {
      min-height: 60px;
      resize: vertical;
    }

    .pairs-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .pairs-grid .field {
      display: flex;
      flex-direction: column;
    }

    .pairs-grid label {
      font-size: clamp(11px, 2.6vw, 12.5px);
      font-weight: 500;
      margin-bottom: 3px;
      color: #333;
    }

    
    .terms {
      font-size: clamp(10.5px, 2.5vw, 12px);
      color: #333;
      line-height: 1.4;
      margin-top: 8px;
    }

    .terms a {
      color: #0a2a43;
      font-weight: 600;
      text-decoration: underline;
    }


    .submit-wrap {
      text-align: center;
      margin-top: 14px;
    }

    .submit-btn {
      background: #2f5fa7;
      color: #ffffff;
      padding: 7px 26px;
      border-radius: 4px;
      border: none;
      font-size: clamp(12px, 3vw, 14px);
      font-weight: 600;
      cursor: pointer;
    }

    @media (max-width: 375px) {
      body {
        font-size: 11px;
      }

      .title {
        font-size: 16px;
      }

      .submit-btn {
        font-size: 12px;
      }
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 42, 67, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 12px;
      padding: 28px 32px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      text-align: center;
      animation: modalSlideIn 0.3s ease-out;
    }

    .modal-content.image-only {
      background: transparent;
      padding: 0;
      max-width: none;
      width: auto;
      box-shadow: none;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .modal-icon.success {
      color: #28a745;
    }

    .modal-icon.error {
      color: #dc3545;
    }

    .modal-image {
      max-width: 100%;
      height: auto;
      margin-bottom: 16px;
    }

    .modal-full-image {
      max-width: 90%;
      width: auto;
      height: auto;
      cursor: pointer;
      border-radius: 12px;
    }

    .modal-title {
      font-size: clamp(18px, 4vw, 18px);
      font-weight: 300;
      color: #0a2a43;
      margin-bottom: 12px;
    }

    .modal-message {
      font-size: clamp(13px, 3vw, 15px);
      color: #333;
      line-height: 1.5;
      margin-bottom: 24px;
    }

    .modal-btn {
      background: #2f5fa7;
      color: #ffffff;
      padding: 10px 32px;
      border-radius: 6px;
      border: none;
      font-size: clamp(13px, 3vw, 15px);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .modal-btn:hover {
      background: #264a85;
    }

    .help-text {
      font-size: clamp(10px, 2.4vw, 11.5px);
      color: #666;
      font-style: italic;
      margin-top: 4px;
    }

    /* Loading Modal Styles */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 42, 67, 0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-content {
      background: #ffffff;
      border-radius: 12px;
      padding: 32px 36px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .loading-text {
      font-size: clamp(14px, 3.2vw, 16px);
      font-weight: 600;
      color: #0a2a43;
      margin-bottom: 20px;
    }

    .progress-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
    }

    .progress-step-image {
      max-height: 80px;
      width: auto;
    }

    .progress-separator {
      max-height: 30px;
      width: auto;
      margin: 0 15px;
    }

    /* ===== ATTACHMENT UPLOAD (DESIGN ONLY) ===== */
.upload-box {
  position: relative;
  width: 100%;
  min-height: 140px;
  background: #f3f6fb;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.25s ease;
}

.upload-box:hover {
  background: #eef3ff;
  border: 1px dashed #c7d6ff;
}

.upload-content {
  text-align: center;
  color: #444;
}

.upload-content svg {
  width: 44px;
  height: 44px;
  border-radius: 5px;
  margin-bottom: 10px;
  fill: #555;
}

.upload-text {
  font-size: clamp(14px, 3vw, 16px);
  font-weight: 500;
}

/* hide real input */
.upload-input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}


    /* ===== FILE UPLOAD WITH PREVIEW ===== */
.upload-box {
  position: relative;
  width: 100%;
  min-height: 140px;
  background: #f3f6fb;
  border: 2px dashed #c7d6ff;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.25s ease;
  padding: 20px;
}

.upload-box:hover {
  background: #eef3ff;
  border-color: #2f5fa7;
}

.upload-content {
  text-align: center;
  color: #444;
}

.upload-content svg {
  width: 44px;
  height: 44px;
  fill: #555;
  margin-bottom: 10px;
}

.upload-text {
  font-size: clamp(14px, 3vw, 16px);
  font-weight: 500;
  margin-bottom: 4px;
}

.upload-subtext {
  font-size: clamp(11px, 2.5vw, 12px);
  color: #666;
}

/* hide real input */
.upload-input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

/* File list styles */
.file-list-container {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

.file-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  margin-bottom: 8px;
  background: white;
  border-radius: 6px;
  border: 1px solid #e0e0e0;
  transition: all 0.2s ease;
}

.file-item:hover {
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  border-color: #c7d6ff;
}

.file-info {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  min-width: 0;
}

.file-icon {
  font-size: 20px;
  color: #2f5fa7;
  flex-shrink: 0;
}

.file-name {
  font-size: clamp(11.5px, 2.7vw, 13px);
  color: #333;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
}

.file-size {
  font-size: clamp(10px, 2.4vw, 11.5px);
  color: #666;
  white-space: nowrap;
  flex-shrink: 0;
  margin-left: 8px;
}

.remove-file {
  background: #ff4444;
  color: white;
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  flex-shrink: 0;
  transition: background 0.2s ease;
  margin-left: 8px;
}

.remove-file:hover {
  background: #cc0000;
}

.file-list-empty {
  text-align: center;
  padding: 15px;
  color: #666;
  font-size: clamp(11px, 2.6vw, 12.5px);
  font-style: italic;
}
    /* ===== FILE UPLOAD WITH PREVIEW ===== */
.upload-box {
  position: relative;
  width: 100%;
  min-height: 140px;
  background: #f3f6fb;
  border: 2px dashed #c7d6ff;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.25s ease;
  padding: 20px;
}

.upload-box:hover {
  background: #eef3ff;
  border-color: #2f5fa7;
}

.upload-box.error {
  border-color: #dc3545;
  background: #fff5f5;
  animation: shake 0.5s ease-in-out;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.upload-content {
  text-align: center;
  color: #444;
}

.upload-content svg {
  width: 44px;
  height: 44px;
  fill: #555;
  margin-bottom: 10px;
}

.upload-text {
  font-size: clamp(14px, 3vw, 16px);
  font-weight: 500;
  margin-bottom: 4px;
}

.upload-subtext {
  font-size: clamp(11px, 2.5vw, 12px);
  color: #666;
}

/* hide real input */
.upload-input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

/* Validation message */
.validation-message {
  animation: fadeIn 0.3s ease;
  padding: 5px 10px;
  background: #fff5f5;
  border-radius: 4px;
  border-left: 3px solid #dc3545;
}

/* File list styles */
.file-list-container {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

.file-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  margin-bottom: 8px;
  background: white;
  border-radius: 6px;
  border: 1px solid #e0e0e0;
  transition: all 0.2s ease;
}

.file-item:hover {
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  border-color: #c7d6ff;
}

.file-item.error {
  border-color: #dc3545;
  background: #fff5f5;
}

.file-info {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  min-width: 0;
}

.file-icon {
  font-size: 20px;
  color: #2f5fa7;
  flex-shrink: 0;
}

.file-icon.error {
  color: #dc3545;
}

.file-name {
  font-size: clamp(11.5px, 2.7vw, 13px);
  color: #333;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
}

.file-name.error {
  color: #dc3545;
}

.file-size {
  font-size: clamp(10px, 2.4vw, 11.5px);
  color: #666;
  white-space: nowrap;
  flex-shrink: 0;
  margin-left: 8px;
}

.file-size.error {
  color: #dc3545;
  font-weight: 600;
}

.remove-file {
  background: #ff4444;
  color: white;
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  flex-shrink: 0;
  transition: background 0.2s ease;
  margin-left: 8px;
}

.remove-file:hover {
  background: #cc0000;
}

.file-list-empty {
  text-align: center;
  padding: 15px;
  color: #666;
  font-size: clamp(11px, 2.6vw, 12.5px);
  font-style: italic;
}

/* Summary styles */
.file-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: #f0f4f9;
  border-radius: 6px;
  margin-top: 10px;
  font-size: 12px;
}

.total-size {
  color: #333;
  font-weight: 600;
}

.total-count {
  color: #2f5fa7;
  font-weight: 600;
}
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="header">
    <img src="https://i.ibb.co/ZpQnHQLd/image.png" alt="CRS Jet Spares" />
    <div class="tag">
      Parts. Problems. Solved
      <div>We offer More than just Parts. We offer Solutions.</div>
    </div>
  </div>

  <!-- CARD -->
  <div class="page">
    <div class="title">Core Card</div>

    <!-- FORM WRAPPER -->
    <div class="form-wrap">
      <form novalidate>

        <!-- SUBJECT -->
        <div class="row">
          <label>CRS SO-# <span style="color:red">*</span></label>
          <input id="subject" name="subject" type="text" />
          <div class="help-text">Please enter the Sales Order number in format - SO-xxxxx</div>
        </div>

        <!-- CUSTOMER PO -->
        <div class="row">
          <label>Customer PO-# <span style="color:red">*</span></label>
          <input id="customerPo" name="customerPo" type="text" />
          <div class="help-text">PO number provided to CRS to purchase the unit</div>
        </div>

        <!-- CUSTOMER NAME -->
        <div class="row">
          <label>Name <span style="color:red">*</span></label>
          <input name="customerName" type="text" />
        </div>

        <!-- COMPANY -->
        <div class="row">
          <label>Company Name <span style="color:red">*</span></label>
          <input name="company" type="text" />
        </div>

        <!-- PART NUMBER -->
        <div class="row">
          <label>Part Number <span style="color:red">*</span></label>
          <input name="partNumber" type="text" />
        </div>

        <!-- SERIAL NUMBER -->
        <div class="row">
          <label>Serial Number <span style="color:red">*</span></label>
          <input name="serialNumber" type="text" />
        </div>

        <!-- TSN / TSO / CSN / CSO -->
        <div class="pairs-grid">
          <div class="field">
            <label>TSN</label>
            <input name="tsn" type="text" />
          </div>
          <div class="field">
            <label>TSO</label>
            <input name="tso" type="text" />
          </div>
          <div class="field">
            <label>CSN</label>
            <input name="csn" type="text" />
          </div>
          <div class="field">
            <label>CSO</label>
            <input name="cso" type="text" />
          </div>
        </div>

        <!-- AIRCRAFT DETAILS -->
        <div class="row">
          <label>Aircraft Type <span style="color:red">*</span></label>
          <input name="aircraftType" type="text" />
        </div>

        <div class="row">
          <label>Aircraft Serial Number <span style="color:red">*</span></label>
          <input name="aircraftSerial" type="text" />
        </div>

        <div class="row">
          <label>Aircraft Tail Number <span style="color:red">*</span></label>
          <input name="aircraftTail" type="text" />
        </div>

        <!-- REASON FOR REMOVAL -->
        <div class="row">
          <label>Reason For Removal <span style="color:red">*</span></label>
          <textarea name="reasonForRemoval"></textarea>
        </div>

        <!-- FILE ATTACHMENTS -->
        <!-- <div class="row">
          <label>Attach Files (Optional)</label>
          <input id="fileAttachment" type="file" multiple style="padding: 6px;" />
        </div> -->

        <!-- FILE ATTACHMENTS -->
        <div class="row">
          <label>Attach Files (Optional)</label>
        
          <label class="upload-box">
            <input
              id="fileAttachment"
              class="upload-input"
              type="file"
              multiple
            />
            
            <div class="upload-content" id="uploadContent">
              <svg viewBox="0 0 24 24">
                <path d="M5 20h14a1 1 0 0 0 1-1v-4h-2v3H6v-3H4v4a1 1 0 0 0 1 1z"/>
                <path d="M11 16h2V8h3l-4-4-4 4h3z"/>
              </svg>
              <div class="upload-text">
                Click to upload files
              </div>
              <div class="upload-subtext" id="uploadSubtext" style="font-size: 12px; color: #666; margin-top: 5px;">
                Max 33 files, total size: 5MB
              </div>
            </div>
          </label>
          
          <!-- Validation message -->
          <div id="fileValidation" class="validation-message" style="display: none; color: #dc3545; font-size: 11px; margin-top: 5px;"></div>
          
          <!-- Selected files display -->
          <div id="fileList" class="file-list-container" style="display: none; margin-top: 10px;">
            <div style="font-size: 12px; font-weight: 600; color: #444; margin-bottom: 5px;">
              Selected Files:
            </div>
            <div id="selectedFiles" style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px; background: #f9f9f9;">
              <!-- Files will be listed here -->
            </div>
          </div>
        </div>


        <!-- TERMS -->
        <div class="terms">
          I hereby state this part was removed from the aircraft identified above and has not been subjected to any major engine failure, accident, or fire.
          By submitting the digital core card form, you agree to the
          <a href="https://crsjetspares.com/general-terms-and-conditions-for-sale-and-exchange-of-goods/" target="_blank">
            Terms and Conditions
          </a>.
        </div>

        <!-- SUBMIT -->
        <div class="submit-wrap">
          <button class="submit-btn" type="submit">Submit</button>
        </div>

      </form>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loadingModal" class="loading-overlay">
    <div class="loading-content">
      <div id="loadingText" class="loading-text">Processing...</div>
      <div class="progress-steps">
        <img id="verifyingIcon" src="assets/VerifyingSalesOrder.png" class="progress-step-image" alt="Verifying" />
        <img id="separator" src="assets/SeparatorGrey.png" class="progress-separator" alt="Separator" />
        <img id="preparingIcon" src="assets/PreparingSubmissionGrey.png" class="progress-step-image" alt="Preparing" />
      </div>
    </div>
  </div>

  <!-- Modal Popup -->
  <div id="modal" class="modal-overlay">
    <div class="modal-content">
      <div id="modalIcon" class="modal-icon"></div>
      <div id="modalTitle" class="modal-title"></div>
      <div id="modalMessage" class="modal-message"></div>
      <button class="modal-btn" onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    // File validation constants (will be updated from metadata)
let MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB in bytes (default)
const MAX_FILE_COUNT = 33;
let ALLOWED_FILE_FORMATS = []; // Will be populated from metadata
let fileSettingsLoaded = false;

// Function to format file size
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Function to get file icon based on extension
function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const icons = {
    pdf: 'ðŸ“„',
    doc: 'ðŸ“',
    docx: 'ðŸ“',
    txt: 'ðŸ“ƒ',
    jpg: 'ðŸ–¼ï¸',
    jpeg: 'ðŸ–¼ï¸',
    png: 'ðŸ–¼ï¸',
    gif: 'ðŸ–¼ï¸',
    bmp: 'ðŸ–¼ï¸',
    tiff: 'ðŸ–¼ï¸',
    svg: 'ðŸ–¼ï¸',
    xls: 'ðŸ“Š',
    xlsx: 'ðŸ“Š',
    zip: 'ðŸ“¦',
    rar: 'ðŸ“¦',
    '7z': 'ðŸ“¦',
    xml: 'ðŸ“‹',
    csv: 'ðŸ“Š',
    json: 'ðŸ“‹',
    log: 'ðŸ“‹'
  };
  return icons[ext] || 'ðŸ“Ž';
}

// Function to get file extension
function getFileExtension(filename) {
  return filename.split('.').pop().toLowerCase();
}

// Function to validate files
function validateFiles(files) {
  const validation = {
    valid: true,
    errors: [],
    invalidFormatFiles: [],
    totalSize: 0,
    validFiles: []
  };

  // Check file count
  if (files.length > MAX_FILE_COUNT) {
    validation.valid = false;
    validation.errors.push(`Maximum ${MAX_FILE_COUNT} files allowed. You selected ${files.length} files.`);
  }

  // Check each file for format and calculate total size
  Array.from(files).forEach((file, index) => {
    let fileIsValid = true;

    // Check file format if settings are loaded
    if (fileSettingsLoaded && ALLOWED_FILE_FORMATS.length > 0) {
      const fileExt = getFileExtension(file.name);
      if (!ALLOWED_FILE_FORMATS.includes(fileExt)) {
        validation.valid = false;
        fileIsValid = false;
        validation.invalidFormatFiles.push({
          name: file.name,
          extension: fileExt,
          index: index
        });
        validation.errors.push(`"${file.name}" has invalid format. Allowed formats: ${ALLOWED_FILE_FORMATS.join(', ')}`);
      }
    }

    // Add to valid files and calculate total size
    if (fileIsValid) {
      validation.validFiles.push(file);
      validation.totalSize += file.size;
    }
  });

  // Check total size of all files combined
  if (fileSettingsLoaded && validation.totalSize > MAX_FILE_SIZE) {
    validation.valid = false;
    validation.errors.push(`Total file size (${formatFileSize(validation.totalSize)}) exceeds maximum allowed (${formatFileSize(MAX_FILE_SIZE)})`);
  }

  return validation;
}

// Function to show validation error
function showFileValidationError(message) {
  const validationDiv = document.getElementById('fileValidation');
  const uploadBox = document.querySelector('.upload-box');
  
  validationDiv.textContent = message;
  validationDiv.style.display = 'block';
  uploadBox.classList.add('error');
  
  // Remove error state after 5 seconds
  setTimeout(() => {
    validationDiv.style.display = 'none';
    uploadBox.classList.remove('error');
  }, 5000);
}

// Function to display selected files
function displaySelectedFiles() {
  const fileInput = document.getElementById('fileAttachment');
  const fileListContainer = document.getElementById('fileList');
  const selectedFilesDiv = document.getElementById('selectedFiles');
  const uploadContent = document.getElementById('uploadContent');
  const validationDiv = document.getElementById('fileValidation');
  const uploadBox = document.querySelector('.upload-box');
  
  // Clear validation
  validationDiv.style.display = 'none';
  uploadBox.classList.remove('error');
  
  if (fileInput.files.length > 0) {
    // Validate files
    const validation = validateFiles(fileInput.files);
    
    if (!validation.valid) {
      showFileValidationError(validation.errors.join(', '));
      
      // Filter out invalid files
      const dataTransfer = new DataTransfer();
      validation.validFiles.forEach(file => dataTransfer.items.add(file));
      fileInput.files = dataTransfer.files;
      
      // If no valid files remain, reset
      if (fileInput.files.length === 0) {
        const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(1);
        uploadContent.innerHTML = `
          <svg viewBox="0 0 24 24">
            <path d="M5 20h14a1 1 0 0 0 1-1v-4h-2v3H6v-3H4v4a1 1 0 0 0 1 1z"/>
            <path d="M11 16h2V8h3l-4-4-4 4h3z"/>
          </svg>
          <div class="upload-text">
            Click to upload files
          </div>
          <div class="upload-subtext" style="font-size: 12px; color: #666; margin-top: 5px;">
            Max 33 files, total size: ${maxSizeMB}MB
          </div>
        `;
        fileListContainer.style.display = 'none';
        return;
      }
    }
    
    // Update upload box appearance
    uploadContent.innerHTML = `
      <svg viewBox="0 0 24 24">
        <path d="M5 20h14a1 1 0 0 0 1-1v-4h-2v3H6v-3H4v4a1 1 0 0 0 1 1z"/>
        <path d="M11 16h2V8h3l-4-4-4 4h3z"/>
      </svg>
      <div class="upload-text">
        ${fileInput.files.length} file${fileInput.files.length > 1 ? 's' : ''} selected
      </div>
      <div class="upload-subtext" style="font-size: 12px; color: #666; margin-top: 5px;">
        Click to change files
      </div>
    `;
    
    // Display files list
    selectedFilesDiv.innerHTML = '';
    
    let totalSize = 0;
    
    Array.from(fileInput.files).forEach((file, index) => {
      const fileExt = getFileExtension(file.name);
      const isInvalidFormat = fileSettingsLoaded && ALLOWED_FILE_FORMATS.length > 0 && !ALLOWED_FILE_FORMATS.includes(fileExt);
      totalSize += file.size;

      let errorMessage = '';
      if (isInvalidFormat) {
        errorMessage = ' (Invalid format!)';
      }

      const fileItem = document.createElement('div');
      fileItem.className = `file-item ${isInvalidFormat ? 'error' : ''}`;
      fileItem.innerHTML = `
        <div class="file-info">
          <span class="file-icon ${isInvalidFormat ? 'error' : ''}">${getFileIcon(file.name)}</span>
          <span class="file-name ${isInvalidFormat ? 'error' : ''}" title="${file.name}">${file.name}</span>
          <span class="file-size ${isInvalidFormat ? 'error' : ''}">${formatFileSize(file.size)}${errorMessage}</span>
        </div>
        <button type="button" class="remove-file" data-index="${index}">Ã—</button>
      `;
      selectedFilesDiv.appendChild(fileItem);
    });
    
    // Add summary
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'file-summary';
    const totalSizeExceeded = fileSettingsLoaded && totalSize > MAX_FILE_SIZE;
    summaryDiv.innerHTML = `
      <div class="total-count">${fileInput.files.length} of ${MAX_FILE_COUNT} files</div>
      <div class="total-size" style="${totalSizeExceeded ? 'color: #dc3545; font-weight: 700;' : ''}">
        Total: ${formatFileSize(totalSize)}${totalSizeExceeded ? ' (Exceeds limit!)' : ''}
        ${fileSettingsLoaded ? ' / ' + formatFileSize(MAX_FILE_SIZE) : ''}
      </div>
    `;
    selectedFilesDiv.appendChild(summaryDiv);
    
    fileListContainer.style.display = 'block';
    
    // Add event listeners to remove buttons
    selectedFilesDiv.querySelectorAll('.remove-file').forEach(button => {
      button.addEventListener('click', function(e) {
        e.stopPropagation();
        const index = parseInt(this.getAttribute('data-index'));
        removeFile(index);
      });
    });
    
  } else {
    // Reset upload box to default
    const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(1);
    uploadContent.innerHTML = `
      <svg viewBox="0 0 24 24">
        <path d="M5 20h14a1 1 0 0 0 1-1v-4h-2v3H6v-3H4v4a1 1 0 0 0 1 1z"/>
        <path d="M11 16h2V8h3l-4-4-4 4h3z"/>
      </svg>
      <div class="upload-text">
        Click to upload files
      </div>
      <div class="upload-subtext" style="font-size: 12px; color: #666; margin-top: 5px;">
        Max 33 files, total size: ${maxSizeMB}MB
      </div>
    `;
    fileListContainer.style.display = 'none';
  }
}

// Function to remove a file
function removeFile(index) {
  const fileInput = document.getElementById('fileAttachment');
  const files = Array.from(fileInput.files);

  if (index >= 0 && index < files.length) {
    files.splice(index, 1);

    // Create a new DataTransfer to update the file input
    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;

    // Update the stored files array
    window.uploadedFiles = files;

    // Update the display
    displaySelectedFiles();
  }
}

// Function to validate files before form submission
function validateFilesBeforeSubmit() {
  const fileInput = document.getElementById('fileAttachment');

  if (fileInput.files.length === 0) {
    return { valid: true, message: '' };
  }

  // Calculate total size of all files
  let totalSize = 0;
  const invalidFormatFiles = [];

  Array.from(fileInput.files).forEach((file) => {
    totalSize += file.size;

    // Check file format if settings are loaded
    if (fileSettingsLoaded && ALLOWED_FILE_FORMATS.length > 0) {
      const fileExt = getFileExtension(file.name);
      if (!ALLOWED_FILE_FORMATS.includes(fileExt)) {
        invalidFormatFiles.push(file.name);
      }
    }
  });

  // Check for invalid format files
  if (invalidFormatFiles.length > 0) {
    return {
      valid: false,
      message: `The following file(s) have invalid format: ${invalidFormatFiles.join(', ')}. Allowed formats: ${ALLOWED_FILE_FORMATS.join(', ').toUpperCase()}`
    };
  }

  // Check total size
  if (fileSettingsLoaded && totalSize > MAX_FILE_SIZE) {
    return {
      valid: false,
      message: `Total file size (${formatFileSize(totalSize)}) exceeds maximum allowed (${formatFileSize(MAX_FILE_SIZE)}). Please remove some files.`
    };
  }

  // Check file count
  if (fileInput.files.length > MAX_FILE_COUNT) {
    return {
      valid: false,
      message: `Maximum ${MAX_FILE_COUNT} files allowed. You have ${fileInput.files.length} files.`
    };
  }

  return { valid: true, message: '' };
}

// Add event listener for file selection with appending functionality
document.getElementById('fileAttachment').addEventListener('change', function(e) {
  const fileInput = e.target;
  const newFiles = Array.from(fileInput.files);

  // Get existing files from the hidden storage
  const existingFiles = window.uploadedFiles || [];

  // Combine existing and new files
  const allFiles = [...existingFiles, ...newFiles];

  // Validate total file count
  if (allFiles.length > MAX_FILE_COUNT) {
    showFileValidationError(`Cannot add files. Maximum ${MAX_FILE_COUNT} files allowed. You currently have ${existingFiles.length} file(s) and tried to add ${newFiles.length} more.`);

    // Reset file input without changing existing files
    const dataTransfer = new DataTransfer();
    existingFiles.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
    displaySelectedFiles();
    return;
  }

  // Validate all files (including format and total size)
  const validation = validateFiles(allFiles);

  // If validation fails, only keep valid files
  if (!validation.valid) {
    // Show errors
    showFileValidationError(validation.errors.join(', '));

    // Only add valid files
    const dataTransfer = new DataTransfer();
    validation.validFiles.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
    window.uploadedFiles = Array.from(dataTransfer.files);
    displaySelectedFiles();
    return;
  }

  // Create a new DataTransfer to update the file input with all files
  const dataTransfer = new DataTransfer();
  allFiles.forEach(file => dataTransfer.items.add(file));
  fileInput.files = dataTransfer.files;

  // Store the combined files for future appends
  window.uploadedFiles = allFiles;

  displaySelectedFiles();
});

// Optional: Add drag and drop functionality with validation
const uploadBox = document.querySelector('.upload-box');

uploadBox.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadBox.style.borderColor = '#2f5fa7';
  uploadBox.style.background = '#eef3ff';
});

uploadBox.addEventListener('dragleave', (e) => {
  e.preventDefault();
  uploadBox.style.borderColor = '#c7d6ff';
  uploadBox.style.background = '#f3f6fb';
});

uploadBox.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadBox.style.borderColor = '#c7d6ff';
  uploadBox.style.background = '#f3f6fb';

  const files = e.dataTransfer.files;
  const fileInput = document.getElementById('fileAttachment');

  // Validate before adding
  const validation = validateFiles(files);

  // Create a new DataTransfer to handle multiple selections
  const dataTransfer = new DataTransfer();

  // Add existing files
  const existingFiles = window.uploadedFiles || [];
  existingFiles.forEach(file => dataTransfer.items.add(file));

  // Check if adding new files would exceed limit
  const totalFilesAfterAdd = dataTransfer.files.length + validation.validFiles.length;
  if (totalFilesAfterAdd > MAX_FILE_COUNT) {
    showFileValidationError(`Cannot add files. Maximum ${MAX_FILE_COUNT} files allowed. You would have ${totalFilesAfterAdd} files.`);
    return;
  }

  // Add valid files
  validation.validFiles.forEach(file => dataTransfer.items.add(file));

  // Show errors for invalid format files
  if (validation.invalidFormatFiles && validation.invalidFormatFiles.length > 0) {
    showFileValidationError(`${validation.invalidFormatFiles.length} file(s) have invalid format and were not added.`);
  }

  // Check if total size exceeds limit
  const totalSize = Array.from(dataTransfer.files).reduce((sum, file) => sum + file.size, 0);
  if (fileSettingsLoaded && totalSize > MAX_FILE_SIZE) {
    showFileValidationError(`Total file size (${formatFileSize(totalSize)}) exceeds maximum allowed (${formatFileSize(MAX_FILE_SIZE)})`);
  }

  fileInput.files = dataTransfer.files;

  // Update stored files array
  window.uploadedFiles = Array.from(dataTransfer.files);

  // Trigger display update directly (no need to trigger change event which would duplicate the append logic)
  displaySelectedFiles();
});

    

    
    const CLIENT_ID = '3MVG9O_Hkc8TP1aFEeEWU9ZyX2f05bkHPl2XawuPFSJwal8ZF1mDPue9o0kPDBVcOU64PRCCEZnQq2aIJmKv5';
    const CLIENT_SECRET = '4DA156C1380C7AA53FCE2C408620F764D3D46C7C4453D58077B173206EA351C5';
    const SF_INSTANCE = 'https://prod-avs-crsjetspares--crsdev25.sandbox.my.salesforce.com';
    const OAUTH_URL = SF_INSTANCE + '/services/oauth2/token';
    const API_ENDPOINT = SF_INSTANCE + '/services/apexrest/caseManagement/';

    // Modal Functions
    function showModal(type, title, message, onClose) {
      const modal = document.getElementById('modal');
      const modalContent = modal.querySelector('.modal-content');

      // Always use standard modal layout
      modalContent.className = 'modal-content';

      const modalIcon = document.getElementById('modalIcon');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');

      // Reset to standard layout if it was changed
      if (!modalIcon) {
        modalContent.innerHTML = `
          <div id="modalIcon" class="modal-icon"></div>
          <div id="modalTitle" class="modal-title"></div>
          <div id="modalMessage" class="modal-message"></div>
          <button class="modal-btn" onclick="closeModal()">OK</button>
        `;
      }

      const icon = document.getElementById('modalIcon');
      const titleEl = document.getElementById('modalTitle');
      const messageEl = document.getElementById('modalMessage');

      if (type === 'success') {
        icon.innerHTML = '<img src="assets/Success.png" class="modal-image" alt="Success" />';
        icon.className = '';
      } else if (type === 'crs-not-found') {
        icon.innerHTML = '<img src="assets/NotFound.png" class="modal-image" alt="Not Found" />';
        icon.className = '';
      } else {
        icon.innerHTML = 'âœ•';
        icon.className = 'modal-icon error';
      }

      titleEl.textContent = title;
      messageEl.textContent = message;
      modal.className = 'modal-overlay show';

      window.modalOnClose = onClose;
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      modal.className = 'modal-overlay';

      if (window.modalOnClose) {
        window.modalOnClose();
        window.modalOnClose = null;
      }
    }

    // Loading Modal Functions
    function showLoading(text, stage) {
      const loadingModal = document.getElementById('loadingModal');
      const loadingText = document.getElementById('loadingText');
      const verifyingIcon = document.getElementById('verifyingIcon');
      const separator = document.getElementById('separator');
      const preparingIcon = document.getElementById('preparingIcon');

      loadingText.textContent = text;

      // Reset to initial state
      verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
      separator.src = 'assets/SeparatorGrey.png';
      preparingIcon.src = 'assets/PreparingSubmissionGrey.png';

      loadingModal.className = 'loading-overlay show';
    }

    function updateLoading(text, stage) {
      const loadingText = document.getElementById('loadingText');
      const verifyingIcon = document.getElementById('verifyingIcon');
      const separator = document.getElementById('separator');
      const preparingIcon = document.getElementById('preparingIcon');

      loadingText.textContent = text;

      // Update icons based on stage
      if (stage === 'verifying') {
        verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
        separator.src = 'assets/SeparatorGrey.png';
        preparingIcon.src = 'assets/PreparingSubmissionGrey.png';
      } else if (stage === 'verified') {
        verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
        separator.src = 'assets/SeparatorBlue.png';
        preparingIcon.src = 'assets/PreparingSubmissionGrey.png';
      } else if (stage === 'preparing') {
        verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
        separator.src = 'assets/SeparatorBlue.png';
        preparingIcon.src = 'assets/PreparingSubmissionGrey.png';
      } else if (stage === 'complete') {
        verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
        separator.src = 'assets/SeparatorBlue.png';
        preparingIcon.src = 'assets/PreparingSubmission.png';
      }
    }

    function hideLoading() {
      const loadingModal = document.getElementById('loadingModal');
      loadingModal.className = 'loading-overlay';
    }

    async function getAccessToken() {
      const params = new URLSearchParams();
      params.append('grant_type', 'client_credentials');
      params.append('client_id', CLIENT_ID);
      params.append('client_secret', CLIENT_SECRET);

      const response = await fetch(OAUTH_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params
      });

      if (!response.ok) {
        throw new Error('Failed to authenticate');
      }

      const data = await response.json();
      return data.access_token;
    }

    async function fetchFileSettings() {
      try {
        const accessToken = await getAccessToken();

        // Query custom metadata for CoreCardSetting
        const query = "SELECT File_Formats__c, Maximum_Size__c FROM FilesAttachmentSettings__mdt WHERE DeveloperName='CoreCardSetting' LIMIT 1";
        const url = SF_INSTANCE + '/services/data/v62.0/query?q=' + encodeURIComponent(query);

        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          console.error('Failed to fetch file settings from metadata');
          return false;
        }

        const data = await response.json();

        if (data.records && data.records.length > 0) {
          const settings = data.records[0];

          // Parse file formats (comma-separated)
          if (settings.File_Formats__c) {
            ALLOWED_FILE_FORMATS = settings.File_Formats__c
              .split(',')
              .map(format => format.trim().toLowerCase())
              .filter(format => format.length > 0);
          }

          // Parse maximum size (in MB)
          if (settings.Maximum_Size__c) {
            MAX_FILE_SIZE = parseFloat(settings.Maximum_Size__c) * 1024 * 1024; // Convert MB to bytes
          }

          fileSettingsLoaded = true;

          // Update the UI label with allowed formats
          updateFileLabel();

          // Update the file input accept attribute
          updateFileInputAccept();

          return true;
        }

        return false;
      } catch (error) {
        console.error('Error fetching file settings:', error);
        return false;
      }
    }

    function updateFileLabel() {
      const label = document.querySelector('label[for="fileAttachment"]');
      if (!label) {
        // Find the label by looking for the one before the upload box
        const labels = document.querySelectorAll('.row label');
        for (let i = 0; i < labels.length; i++) {
          if (labels[i].textContent.includes('Attach Files')) {
            updateLabelText(labels[i]);
            return;
          }
        }
      } else {
        updateLabelText(label);
      }
    }

    function updateLabelText(label) {
      if (ALLOWED_FILE_FORMATS.length > 0) {
        const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(1);
        const formatsText = ALLOWED_FILE_FORMATS.join(', ').toUpperCase();
        label.innerHTML = `Attach Files (Optional) <span style="color: #666; font-weight: 400; font-size: 11px;">(Allowed formats: ${formatsText}, Max total size: ${maxSizeMB}MB)</span>`;
      }
    }

    function updateFileInputAccept() {
      const fileInput = document.getElementById('fileAttachment');
      if (fileInput && ALLOWED_FILE_FORMATS.length > 0) {
        // Create accept attribute with dot prefix for each format
        fileInput.setAttribute('accept', ALLOWED_FILE_FORMATS.map(format => '.' + format).join(','));
      }

      // Update the upload subtext
      const uploadSubtext = document.getElementById('uploadSubtext');
      if (uploadSubtext && ALLOWED_FILE_FORMATS.length > 0) {
        const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(1);
        uploadSubtext.textContent = `Max 33 files, total size: ${maxSizeMB}MB`;
      }
    }

    // Initialize file settings on page load
    document.addEventListener('DOMContentLoaded', function() {
      fetchFileSettings();
    });

    async function verifySalesOrder(salesOrderNumber, accessToken) {
      const url = API_ENDPOINT + '?salesOrderNumber=' + encodeURIComponent(salesOrderNumber);

      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error('Failed to verify sales order');
      }

      return await response.json();
    }

    async function createCase(formData, accessToken) {
      const caseData = {
        Subject: formData.subject,
        SuppliedCompany: formData.company,
        Type: 'Sales',
        RecordTypeId: formData.recordTypeId,
        Customer_Name__c: formData.customerName,
        Part_Number__c: formData.partNumber,
        Serial_Number__c: formData.serialNumber,
        TSN__c: formData.tsn,
        TSO__c: formData.tso,
        CSN__c: formData.csn,
        CSO__c: formData.cso,
        Aircraft_Type__c: formData.aircraftType,
        Aircraft_Serial__c: formData.aircraftSerial,
        Aircraft_Tail__c: formData.aircraftTail,
        Reason_For_Removal__c: formData.reasonForRemoval,
        Sub_Type__c: 'Information',
        Category__c: 'Core Card Form',
        Customer_PO__c : formData.customerPo
      };

      const response = await fetch(SF_INSTANCE + '/services/data/v62.0/sobjects/Case', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(caseData)
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('Case creation error:', errorData);
        throw new Error('Failed to create case');
      }

      const result = await response.json();
      return result.id;
    }

    async function uploadFile(file, caseId, accessToken) {
      const reader = new FileReader();

      return new Promise((resolve, reject) => {
        reader.onload = async function(e) {
          const base64Content = btoa(
            new Uint8Array(e.target.result)
              .reduce((data, byte) => data + String.fromCharCode(byte), '')
          );

          const contentVersionData = {
            Title: file.name,
            PathOnClient: file.name,
            VersionData: base64Content,
            FirstPublishLocationId: caseId
          };

          try {
            const response = await fetch(SF_INSTANCE + '/services/data/v62.0/sobjects/ContentVersion', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(contentVersionData)
            });

            if (!response.ok) {
              const errorData = await response.json();
              console.error('File upload error:', errorData);
              throw new Error('Failed to upload file: ' + file.name);
            }

            resolve();
          } catch (error) {
            reject(error);
          }
        };

        reader.onerror = function() {
          reject(new Error('Failed to read file: ' + file.name));
        };

        reader.readAsArrayBuffer(file);
      });
    }

    function extractSalesOrderNumber(subject) {
      const match = subject.match(/SO-\d+/i);
      return match ? match[0].toUpperCase() : null;
    }

    async function getRecordTypeId(accessToken) {
      const query = "SELECT Id FROM RecordType WHERE SobjectType='Case' AND DeveloperName='Sales' LIMIT 1";
      const url = SF_INSTANCE + '/services/data/v62.0/query?q=' + encodeURIComponent(query);

      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error('Failed to query Record Type');
      }

      const data = await response.json();
      if (data.records && data.records.length > 0) {
        return data.records[0].Id;
      } else {
        throw new Error('Sales Record Type not found');
      }
    }

    document.querySelector("form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = e.target;
      const subject = document.getElementById("subject");
      const submitBtn = document.querySelector(".submit-btn");
      const fileInput = document.getElementById("fileAttachment");

      // Validate all required fields
      if (!subject.value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Sales Order Number.');
        return;
      }

      if (!form.querySelector('[name="customerPo"]').value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Customer PO Number.');
        return;
      }

      if (!form.querySelector('[name="customerName"]').value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Name.');
        return;
      }

      if (!form.querySelector('[name="company"]').value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Company Name.');
        return;
      }

      if (!form.querySelector('[name="partNumber"]').value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Part Number.');
        return;
      }

      if (!form.querySelector('[name="serialNumber"]').value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Serial Number.');
        return;
      }

      if (!form.querySelector('[name="aircraftType"]').value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Aircraft Type.');
        return;
      }

      if (!form.querySelector('[name="aircraftSerial"]').value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Aircraft Serial Number.');
        return;
      }

      if (!form.querySelector('[name="aircraftTail"]').value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Aircraft Tail Number.');
        return;
      }

      if (!form.querySelector('[name="reasonForRemoval"]').value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Reason For Removal.');
        return;
      }

      const salesOrderNumber = extractSalesOrderNumber(subject.value);
      if (!salesOrderNumber) {
        showModal('error', 'Invalid Format', 'Please enter a valid Sales Order Number in the format SO-XXXXX');
        return;
      }

      // Validate files before proceeding
      const fileValidation = validateFilesBeforeSubmit();
      if (!fileValidation.valid) {
        showModal('error', 'File Upload Error', fileValidation.message);
        return;
      }

      submitBtn.disabled = true;
      showLoading('Verifying Sales Order...', 'verifying');

      try {
        const accessToken = await getAccessToken();
        updateLoading('Verifying Sales Order...', 'verifying');

        const verificationResult = await verifySalesOrder(salesOrderNumber, accessToken);

        if (!verificationResult.salesOrderExists) {
          hideLoading();
          showModal('crs-not-found', 'CRS Order Not found', 'Sales Order number entered does not match as records.');
          submitBtn.disabled = false;
          return;
        }

        updateLoading('Sales Order Verified', 'verified');

        // Prepare form data
        const formData = {
          subject: "Support related to " + subject.value,
          company: form.querySelector('[name="company"]').value,
          recordTypeId: null,
          customerName: form.querySelector('[name="customerName"]').value,
          partNumber: form.querySelector('[name="partNumber"]').value,
          serialNumber: form.querySelector('[name="serialNumber"]').value,
          tsn: form.querySelector('[name="tsn"]').value,
          tso: form.querySelector('[name="tso"]').value,
          csn: form.querySelector('[name="csn"]').value,
          cso: form.querySelector('[name="cso"]').value,
          aircraftType: form.querySelector('[name="aircraftType"]').value,
          aircraftSerial: form.querySelector('[name="aircraftSerial"]').value,
          aircraftTail: form.querySelector('[name="aircraftTail"]').value,
          reasonForRemoval: form.querySelector('[name="reasonForRemoval"]').value,
          customerPo: form.querySelector('[name="customerPo"]').value
        };

        updateLoading('Preparing Submission...', 'preparing');
        const recordTypeId = await getRecordTypeId(accessToken);
        formData.recordTypeId = recordTypeId;

        if (fileInput.files.length > 0) {
          updateLoading('Reading Files...', 'preparing');

          const totalFiles = fileInput.files.length;
          const fileDataArray = [];

          for (let i = 0; i < totalFiles; i++) {
            updateLoading(`Reading Files... (${i + 1}/${totalFiles})`, 'preparing');

            // Read file as base64
            const file = fileInput.files[i];
            const fileData = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = function(e) {
                const base64Content = btoa(
                  new Uint8Array(e.target.result)
                    .reduce((data, byte) => data + String.fromCharCode(byte), '')
                );
                resolve({
                  name: file.name,
                  data: base64Content
                });
              };
              reader.onerror = () => reject(new Error('Failed to read file'));
              reader.readAsArrayBuffer(file);
            });

            fileDataArray.push(fileData);
          }

          updateLoading('Files Ready', 'preparing');
          updateLoading('Creating Case in Salesforce...', 'preparing');
          const caseId = await createCase(formData, accessToken);

          updateLoading('Uploading Files...', 'preparing');
          for (let i = 0; i < fileDataArray.length; i++) {
            const contentVersionData = {
              Title: fileDataArray[i].name,
              PathOnClient: fileDataArray[i].name,
              VersionData: fileDataArray[i].data,
              FirstPublishLocationId: caseId
            };

            const response = await fetch(SF_INSTANCE + '/services/data/v62.0/sobjects/ContentVersion', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(contentVersionData)
            });

            if (!response.ok) {
              throw new Error('Failed to upload file: ' + fileDataArray[i].name);
            }
          }

          updateLoading('Submission Complete', 'complete');
        } else {
          updateLoading('Creating Case in Salesforce...', 'preparing');
          const caseId = await createCase(formData, accessToken);
          updateLoading('Submission Complete', 'complete');
        }

        // Show complete state briefly before hiding
        setTimeout(() => {
          hideLoading();
          showModal('success', 'Form Successfully Submitted', '', function() {
            window.location.href = "https://crsjetspares.com";
          });
        }, 500);

      } catch (error) {
        console.error('Submission error:', error);
        hideLoading();
        showModal('error', 'Submission Failed', 'An error occurred while submitting the form. Please try again.');
        submitBtn.disabled = false;
      }
    });
  </script>

</body>
</html>
