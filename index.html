<!-- MT-7455 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Core Card</title>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }


    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      color: #0a2a43;
      font-size: clamp(11px, 2.5vw, 13px); /* smaller on mobile */
      position: relative;
      z-index: 0;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("https://i.ibb.co/hJfMMh17/image-2.png");
      opacity: 0.25;
      background-repeat: no-repeat;
      background-position: top center;
      background-size: 100% 100%;
      z-index: -1;
    }


    .header {
      text-align: center;
      padding: 18px 12px 8px;
    }

    .header img {
      height: 52px;
      width: 160px;
      margin-bottom: 4px;
    }

    .header .tag {
      font-size: clamp(13px, 3vw, 15px);
      font-weight: 600;
    }

    .header .tag div {
      font-size: clamp(11px, 2.6vw, 12.5px);
      font-style: italic;
      font-weight: 500;
      margin-top: 3px;
    }


    .page {
      max-width: 660px;
      margin: 6px auto 20px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .title {
      margin-top: 12px;
      font-size: clamp(17px, 4vw, 22px);
      text-align: center;
      font-weight: 600;
      color: #2f5fa7;
    }

    
    .form-wrap {
      padding: 16px 22px 22px;
    }

    .row {
      display: flex;
      flex-direction: column;
      margin-bottom: 9px;
    }

    .row label {
      font-size: clamp(11px, 2.6vw, 12.5px);
      font-weight: 500;
      margin-bottom: 3px;
      color: #333;
    }

    .row input,
    .row textarea,
    .pairs-grid input {
      width: 100%;
      border: none;
      background: #f0f4f9;
      border-radius: 4px;
      padding: 8px 9px;
      font-size: clamp(11.5px, 2.7vw, 13px);
      outline: none;
    }

    .row textarea {
      min-height: 60px;
      resize: vertical;
    }

    .pairs-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .pairs-grid .field {
      display: flex;
      flex-direction: column;
    }

    .pairs-grid label {
      font-size: clamp(11px, 2.6vw, 12.5px);
      font-weight: 500;
      margin-bottom: 3px;
      color: #333;
    }

    
    .terms {
      font-size: clamp(10.5px, 2.5vw, 12px);
      color: #333;
      line-height: 1.4;
      margin-top: 8px;
    }

    .terms a {
      color: #0a2a43;
      font-weight: 600;
      text-decoration: underline;
    }


    .submit-wrap {
      text-align: center;
      margin-top: 14px;
    }

    .submit-btn {
      background: #2f5fa7;
      color: #ffffff;
      padding: 7px 26px;
      border-radius: 4px;
      border: none;
      font-size: clamp(12px, 3vw, 14px);
      font-weight: 600;
      cursor: pointer;
    }

    @media (max-width: 375px) {
      body {
        font-size: 11px;
      }

      .title {
        font-size: 16px;
      }

      .submit-btn {
        font-size: 12px;
      }
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 42, 67, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 12px;
      padding: 28px 32px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      text-align: center;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .modal-icon.success {
      color: #28a745;
    }

    .modal-icon.error {
      color: #dc3545;
    }

    .modal-title {
      font-size: clamp(18px, 4vw, 22px);
      font-weight: 600;
      color: #0a2a43;
      margin-bottom: 12px;
    }

    .modal-message {
      font-size: clamp(13px, 3vw, 15px);
      color: #333;
      line-height: 1.5;
      margin-bottom: 24px;
    }

    .modal-btn {
      background: #2f5fa7;
      color: #ffffff;
      padding: 10px 32px;
      border-radius: 6px;
      border: none;
      font-size: clamp(13px, 3vw, 15px);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .modal-btn:hover {
      background: #264a85;
    }

    .help-text {
      font-size: clamp(10px, 2.4vw, 11.5px);
      color: #666;
      font-style: italic;
      margin-top: 4px;
    }

    /* Loading Modal Styles */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 42, 67, 0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-content {
      background: #ffffff;
      border-radius: 12px;
      padding: 32px 36px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      margin: 0 auto 20px;
      border: 4px solid #e3f2fd;
      border-top: 4px solid #2f5fa7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: clamp(14px, 3.2vw, 16px);
      font-weight: 600;
      color: #0a2a43;
      margin-bottom: 20px;
    }

    .progress-container {
      width: 100%;
      height: 8px;
      background: #e3f2fd;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #2f5fa7, #4a7bc8);
      border-radius: 4px;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(47, 95, 167, 0.5);
    }

    .progress-label {
      font-size: clamp(11px, 2.6vw, 13px);
      color: #666;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="header">
    <img src="https://i.ibb.co/ZpQnHQLd/image.png" alt="CRS Jet Spares" />
    <div class="tag">
      Parts. Problems. Solved
      <div>We offer More than just Parts. We offer Solutions.</div>
    </div>
  </div>

  <!-- CARD -->
  <div class="page">
    <div class="title">Core Card</div>

    <!-- FORM WRAPPER -->
    <div class="form-wrap">
      <form novalidate>

        <!-- SUBJECT -->
        <div class="row">
          <label>Sales Order Number <span style="color:red">*</span></label>
          <input id="subject" name="subject" type="text" />
          <div class="help-text">Please enter the Sales Order number in format - SO-xxxxx</div>
        </div>

        <!-- CUSTOMER NAME -->
        <div class="row">
          <label>Customer Name <span style="color:red">*</span></label>
          <input name="customerName" type="text" />
        </div>

        <!-- COMPANY -->
        <div class="row">
          <label>Company Name <span style="color:red">*</span></label>
          <input name="company" type="text" />
        </div>

        <!-- PART NUMBER -->
        <div class="row">
          <label>Part Number <span style="color:red">*</span></label>
          <input name="partNumber" type="text" />
        </div>

        <!-- SERIAL NUMBER -->
        <div class="row">
          <label>Serial Number <span style="color:red">*</span></label>
          <input name="serialNumber" type="text" />
        </div>

        <!-- TSN / TSO / CSN / CSO -->
        <div class="pairs-grid">
          <div class="field">
            <label>TSN *</label>
            <input name="tsn" type="text" />
          </div>
          <div class="field">
            <label>TSO *</label>
            <input name="tso" type="text" />
          </div>
          <div class="field">
            <label>CSN *</label>
            <input name="csn" type="text" />
          </div>
          <div class="field">
            <label>CSO *</label>
            <input name="cso" type="text" />
          </div>
        </div>

        <!-- AIRCRAFT DETAILS -->
        <div class="row">
          <label>Aircraft Type *</label>
          <input name="aircraftType" type="text" />
        </div>

        <div class="row">
          <label>Aircraft Serial Number *</label>
          <input name="aircraftSerial" type="text" />
        </div>

        <div class="row">
          <label>Aircraft Tail Number *</label>
          <input name="aircraftTail" type="text" />
        </div>

        <!-- REASON FOR REMOVAL -->
        <div class="row">
          <label>Reason For Removal *</label>
          <textarea name="reasonForRemoval"></textarea>
        </div>

        <!-- FILE ATTACHMENTS -->
        <div class="row">
          <label>Attach Files (Optional)</label>
          <input id="fileAttachment" type="file" multiple style="padding: 6px;" />
        </div>

        <!-- TERMS -->
        <div class="terms">
          I hereby state this part was removed from the aircraft identified above and has not been subjected to any major engine failure, accident, or fire.
          By submitting the digital core card form, you agree to the
          <a href="https://crsjetspares.com/general-terms-and-conditions-for-sale-and-exchange-of-goods/" target="_blank">
            Terms and Conditions
          </a>.
        </div>

        <!-- SUBMIT -->
        <div class="submit-wrap">
          <button class="submit-btn" type="submit">Submit</button>
        </div>

      </form>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loadingModal" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div id="loadingText" class="loading-text">Processing...</div>
      <div class="progress-container">
        <div id="progressBar" class="progress-bar" style="width: 0%"></div>
      </div>
      <div id="progressLabel" class="progress-label">0%</div>
    </div>
  </div>

  <!-- Modal Popup -->
  <div id="modal" class="modal-overlay">
    <div class="modal-content">
      <div id="modalIcon" class="modal-icon"></div>
      <div id="modalTitle" class="modal-title"></div>
      <div id="modalMessage" class="modal-message"></div>
      <button class="modal-btn" onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    const CLIENT_ID = '3MVG9O_Hkc8TP1aFEeEWU9ZyX2f05bkHPl2XawuPFSJwal8ZF1mDPue9o0kPDBVcOU64PRCCEZnQq2aIJmKv5';
    const CLIENT_SECRET = '4DA156C1380C7AA53FCE2C408620F764D3D46C7C4453D58077B173206EA351C5';
    const SF_INSTANCE = 'https://prod-avs-crsjetspares--crsdev25.sandbox.my.salesforce.com';
    const OAUTH_URL = SF_INSTANCE + '/services/oauth2/token';
    const API_ENDPOINT = SF_INSTANCE + '/services/apexrest/caseManagement/';

    // Modal Functions
    function showModal(type, title, message, onClose) {
      const modal = document.getElementById('modal');
      const modalIcon = document.getElementById('modalIcon');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');

      if (type === 'success') {
        modalIcon.innerHTML = '✓';
        modalIcon.className = 'modal-icon success';
      } else {
        modalIcon.innerHTML = '✕';
        modalIcon.className = 'modal-icon error';
      }

      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modal.className = 'modal-overlay show';

      window.modalOnClose = onClose;
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      modal.className = 'modal-overlay';

      if (window.modalOnClose) {
        window.modalOnClose();
        window.modalOnClose = null;
      }
    }

    // Loading Modal Functions
    function showLoading(text, progress) {
      const loadingModal = document.getElementById('loadingModal');
      const loadingText = document.getElementById('loadingText');
      const progressBar = document.getElementById('progressBar');
      const progressLabel = document.getElementById('progressLabel');

      loadingText.textContent = text;
      progressBar.style.width = progress + '%';
      progressLabel.textContent = progress + '%';
      loadingModal.className = 'loading-overlay show';
    }

    function updateLoading(text, progress) {
      const loadingText = document.getElementById('loadingText');
      const progressBar = document.getElementById('progressBar');
      const progressLabel = document.getElementById('progressLabel');

      loadingText.textContent = text;
      progressBar.style.width = progress + '%';
      progressLabel.textContent = progress + '%';
    }

    function hideLoading() {
      const loadingModal = document.getElementById('loadingModal');
      loadingModal.className = 'loading-overlay';
    }

    async function getAccessToken() {
      const params = new URLSearchParams();
      params.append('grant_type', 'client_credentials');
      params.append('client_id', CLIENT_ID);
      params.append('client_secret', CLIENT_SECRET);

      const response = await fetch(OAUTH_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params
      });

      if (!response.ok) {
        throw new Error('Failed to authenticate');
      }

      const data = await response.json();
      return data.access_token;
    }

    async function verifySalesOrder(salesOrderNumber, accessToken) {
      const url = API_ENDPOINT + '?salesOrderNumber=' + encodeURIComponent(salesOrderNumber);

      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error('Failed to verify sales order');
      }

      return await response.json();
    }

    async function createCase(formData, accessToken) {
      const caseData = {
        Subject: formData.subject,
        SuppliedCompany: formData.company,
        Type: 'Sales',
        RecordTypeId: formData.recordTypeId,
        Customer_Name__c: formData.customerName,
        Part_Number__c: formData.partNumber,
        Serial_Number__c: formData.serialNumber,
        TSN__c: formData.tsn,
        TSO__c: formData.tso,
        CSN__c: formData.csn,
        CSO__c: formData.cso,
        Aircraft_Type__c: formData.aircraftType,
        Aircraft_Serial__c: formData.aircraftSerial,
        Aircraft_Tail__c: formData.aircraftTail,
        Reason_For_Removal__c: formData.reasonForRemoval,
        Sub_Type__c: 'Information',
        Category__c: 'Core Card Form'
      };

      const response = await fetch(SF_INSTANCE + '/services/data/v62.0/sobjects/Case', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(caseData)
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('Case creation error:', errorData);
        throw new Error('Failed to create case');
      }

      const result = await response.json();
      return result.id;
    }

    async function uploadFile(file, caseId, accessToken) {
      const reader = new FileReader();

      return new Promise((resolve, reject) => {
        reader.onload = async function(e) {
          const base64Content = btoa(
            new Uint8Array(e.target.result)
              .reduce((data, byte) => data + String.fromCharCode(byte), '')
          );

          const contentVersionData = {
            Title: file.name,
            PathOnClient: file.name,
            VersionData: base64Content,
            FirstPublishLocationId: caseId
          };

          try {
            const response = await fetch(SF_INSTANCE + '/services/data/v62.0/sobjects/ContentVersion', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(contentVersionData)
            });

            if (!response.ok) {
              const errorData = await response.json();
              console.error('File upload error:', errorData);
              throw new Error('Failed to upload file: ' + file.name);
            }

            resolve();
          } catch (error) {
            reject(error);
          }
        };

        reader.onerror = function() {
          reject(new Error('Failed to read file: ' + file.name));
        };

        reader.readAsArrayBuffer(file);
      });
    }

    function extractSalesOrderNumber(subject) {
      const match = subject.match(/SO-\d+/i);
      return match ? match[0].toUpperCase() : null;
    }

    async function getRecordTypeId(accessToken) {
      const query = "SELECT Id FROM RecordType WHERE SobjectType='Case' AND DeveloperName='Sales' LIMIT 1";
      const url = SF_INSTANCE + '/services/data/v62.0/query?q=' + encodeURIComponent(query);

      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error('Failed to query Record Type');
      }

      const data = await response.json();
      if (data.records && data.records.length > 0) {
        return data.records[0].Id;
      } else {
        throw new Error('Sales Record Type not found');
      }
    }

    document.querySelector("form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = e.target;
      const subject = document.getElementById("subject");
      const submitBtn = document.querySelector(".submit-btn");
      const fileInput = document.getElementById("fileAttachment");

      if (!subject.value.trim()) {
        showModal('error', 'Required Field', 'Please enter the Sales Order Number.');
        return;
      }

      const salesOrderNumber = extractSalesOrderNumber(subject.value);
      if (!salesOrderNumber) {
        showModal('error', 'Invalid Format', 'Please enter a valid Sales Order Number in the format SO-XXXXX');
        return;
      }

      submitBtn.disabled = true;
      showLoading('Authenticating...', 0);

      try {
        const accessToken = await getAccessToken();
        updateLoading('Verifying Sales Order...', 20);

        const verificationResult = await verifySalesOrder(salesOrderNumber, accessToken);

        if (!verificationResult.salesOrderExists) {
          hideLoading();
          showModal('error', 'Sales Order Not Found', 'Mentioned Sales Order number does not exist with Us');
          submitBtn.disabled = false;
          return;
        }

        updateLoading('Sales Order Verified', 40);

        // Prepare form data
        const formData = {
          subject: "Support related to " + subject.value,
          company: form.querySelector('[name="company"]').value,
          recordTypeId: null,
          customerName: form.querySelector('[name="customerName"]').value,
          partNumber: form.querySelector('[name="partNumber"]').value,
          serialNumber: form.querySelector('[name="serialNumber"]').value,
          tsn: form.querySelector('[name="tsn"]').value,
          tso: form.querySelector('[name="tso"]').value,
          csn: form.querySelector('[name="csn"]').value,
          cso: form.querySelector('[name="cso"]').value,
          aircraftType: form.querySelector('[name="aircraftType"]').value,
          aircraftSerial: form.querySelector('[name="aircraftSerial"]').value,
          aircraftTail: form.querySelector('[name="aircraftTail"]').value,
          reasonForRemoval: form.querySelector('[name="reasonForRemoval"]').value
        };

        const recordTypeId = await getRecordTypeId(accessToken);
        formData.recordTypeId = recordTypeId;

        if (fileInput.files.length > 0) {
          // Upload files first, then create case with files
          updateLoading('Preparing Files...', 50);

          const totalFiles = fileInput.files.length;
          const fileDataArray = [];

          for (let i = 0; i < totalFiles; i++) {
            const fileProgress = 50 + (30 * ((i + 1) / totalFiles));
            updateLoading(`Processing Files... (${i + 1}/${totalFiles})`, Math.round(fileProgress));

            // Read file as base64
            const file = fileInput.files[i];
            const fileData = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = function(e) {
                const base64Content = btoa(
                  new Uint8Array(e.target.result)
                    .reduce((data, byte) => data + String.fromCharCode(byte), '')
                );
                resolve({
                  name: file.name,
                  data: base64Content
                });
              };
              reader.onerror = () => reject(new Error('Failed to read file'));
              reader.readAsArrayBuffer(file);
            });

            fileDataArray.push(fileData);
          }

          updateLoading('Creating Case...', 85);
          const caseId = await createCase(formData, accessToken);

          updateLoading('Attaching Files to Case...', 90);
          for (let i = 0; i < fileDataArray.length; i++) {
            const contentVersionData = {
              Title: fileDataArray[i].name,
              PathOnClient: fileDataArray[i].name,
              VersionData: fileDataArray[i].data,
              FirstPublishLocationId: caseId
            };

            const response = await fetch(SF_INSTANCE + '/services/data/v62.0/sobjects/ContentVersion', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(contentVersionData)
            });

            if (!response.ok) {
              throw new Error('Failed to upload file: ' + fileDataArray[i].name);
            }
          }

          updateLoading('All Files Attached', 95);
        } else {
          updateLoading('Creating Case...', 85);
          const caseId = await createCase(formData, accessToken);
          updateLoading('Case Created', 95);
        }

        updateLoading('Complete!', 100);
        setTimeout(() => {
          hideLoading();
          showModal('success', 'Thank You!', 'Your form has been submitted successfully.', function() {
            window.location.href = "https://crsjetspares.com";
          });
        }, 500);

      } catch (error) {
        console.error('Submission error:', error);
        hideLoading();
        showModal('error', 'Submission Failed', 'An error occurred while submitting the form. Please try again.');
        submitBtn.disabled = false;
      }
    });
  </script>

</body>
</html>
